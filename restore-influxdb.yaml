- name: Restore MySQL database
  hosts: monitoring_servers
  tasks:
    - name: Download InfluxDB backup
      ansible.builtin.shell: |
        rm -rf {{ backup_user_home_restore_influxdb }}/*
        sudo -u {{ backup_user }} duplicity --no-encryption restore \
          rsync://{{ backup_host_user }}@{{ backup_host_fqdn }}/influxdb \
          {{ backup_user_home_restore_influxdb }}

    - name: Stop Telegraf service
      ansible.builtin.service:
        name: telegraf
        state: stopped

    - name: Restore InfluxDB database
      ansible.builtin.shell: |
        influx -execute 'DROP DATABASE {{ influxdb_db }}'
        influxd restore -portable -database {{ influxdb_db }} {{ backup_user_home_restore_influxdb }}
      ignore_errors: true

    - name: Stop Telegraf service
      ansible.builtin.service:
        name: telegraf
        state: started
